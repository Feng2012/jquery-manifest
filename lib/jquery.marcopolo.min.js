/**
 * Marco Polo v1.4.1
 *
 * A jQuery autocomplete plugin for the discerning developer.
 *
 * https://github.com/jstayton/jquery-marcopolo
 *
 * Copyright 2011 by Justin Stayton
 * Released under the MIT License
 * http://en.wikipedia.org/wiki/MIT_License
 */
(function(f,m){var j={};f.widget("mp.marcoPolo",{options:{cache:!0,compare:!1,data:{},delay:250,formatData:null,formatError:function(){return"<em>Your search could not be completed at this time.</em>"},formatItem:function(a){return a.title||a.name},formatMinChars:function(a){return"<em>Your search must be at least <strong>"+a+"</strong> characters.</em>"},formatNoResults:function(a){return"<em>No results for <strong>"+a+"</strong>.</em>"},hideOnSelect:!0,label:null,minChars:1,onChange:null,onError:null,
onFocus:null,onMinChars:null,onNoResults:null,onRequestBefore:null,onRequestAfter:null,onResults:null,onSelect:function(a){this.val(a.title||a.name)},param:"q",required:!1,selectable:"*",selected:null,url:null},keys:{DOWN:40,ENTER:13,ESC:27,UP:38},_create:function(){this.$input=this.element.addClass("mp_input");this.$list=f('<ol class="mp_list" />').hide().insertAfter(this.$input);this.autocomplete=this.$input.attr("autocomplete");this.$input.attr("autocomplete","off");this.ajax=null;this.ajaxAborted=
!1;this.documentMouseup=null;this.mousedown=this.focusReal=this.focusPseudo=!1;this.selected=null;this.selectedMouseup=!1;this.timer=null;this.value=this.$input.val();this._bindInput()._bindList()._bindDocument();this._initOptions()._initSelected()},_setOption:function(a,b){f.Widget.prototype._setOption.apply(this,arguments);this._initOptions(a,b)},_initOptions:function(a,b){var c=this,d=a===m,e={};d?e=c.options:e[a]=b;f.each(e,function(a,b){switch(a){case "label":c.options.label=f(b).addClass("mp_label");
c._toggleLabel();break;case "selected":d&&b&&c.select(b,null);break;case "url":if(!b)c.options.url=c.$input.closest("form").attr("action")}});return c},change:function(a){a!==this.value&&(this.$input.val(a),this._change(a),this.focusPseudo?this._cancelPendingRequest()._hideAndEmptyList():this._toggleLabel())},search:function(a){var b=this.$input;a!==m&&b.val(a);b.focus()},select:function(a,b){var c=this.$input,d=this.options.hideOnSelect;this.selected=a;d&&this._hideList();a?this._trigger("select",
[a,b]):c.val("");if(c.val()!==this.value)this.value=c.val(),this.focusPseudo||this._toggleLabel(),this._hideAndEmptyList()},_initSelected:function(){var a=this.$input,b=a.data("selected"),a=a.val();b?this.select(b,null):a&&this.select(a,null);return this},destroy:function(){var a=this.options;this.$list.remove();"off"!==this.autocomplete&&this.$input.removeAttr("autocomplete");this.$input.removeClass("mp_input");a.label&&a.label.removeClass("mp_label");f(document).unbind("mouseup.marcoPolo",this.documentMouseup);
f.Widget.prototype.destroy.apply(this,arguments)},list:function(){return this.$list},_bindInput:function(){var a=this,b=a.$input,c=a.$list;b.bind("focus.marcoPolo",function(){if(!a.focusReal)a.focusPseudo=!0,a.focusReal=!0,a._toggleLabel(),a.selectedMouseup?a.selectedMouseup=!1:(a._trigger("focus"),a._request(b.val()))}).bind("keydown.marcoPolo",function(b){var e=f();switch(b.which){case a.keys.UP:b.preventDefault();a._showList()._highlightPrev();break;case a.keys.DOWN:b.preventDefault();a._showList()._highlightNext();
break;case a.keys.ENTER:b.preventDefault();if(!c.is(":visible"))break;e=a._highlighted();e.length&&a.select(e.data("marcoPolo"),e);break;case a.keys.ESC:a._cancelPendingRequest()._hideList()}}).bind("keyup.marcoPolo",function(){b.val()!==a.value&&a._request(b.val())}).bind("blur.marcoPolo",function(){a.focusReal=!1;setTimeout(function(){if(!a.mousedown)a.focusPseudo=!1,a._dismiss()},1)});return a},_bindList:function(){var a=this;a.$list.bind("mousedown.marcoPolo",function(){a.mousedown=!0}).delegate("li.mp_selectable",
"mouseover",function(){a._addHighlight(f(this))}).delegate("li.mp_selectable","mouseout",function(){a._removeHighlight(f(this))}).delegate("li.mp_selectable","mouseup",function(){var b=f(this);a.select(b.data("marcoPolo"),b);a.selectedMouseup=!0;a.$input.focus()});return a},_bindDocument:function(){var a=this;f(document).bind("mouseup.marcoPolo",a.documentMouseup=function(){a.mousedown=!1;if(!a.focusReal&&a.$list.is(":visible"))a.focusPseudo=!1,a._dismiss()});return a},_toggleLabel:function(){var a=
this.options.label;a.length&&(this.focusPseudo||this.$input.val()?a.hide():a.show());return this},_firstSelectableItem:function(){return this.$list.children("li.mp_selectable:visible:first")},_lastSelectableItem:function(){return this.$list.children("li.mp_selectable:visible:last")},_highlighted:function(){return this.$list.children("li.mp_highlighted")},_removeHighlight:function(a){a.removeClass("mp_highlighted");return this},_addHighlight:function(a){this._removeHighlight(this._highlighted());a.addClass("mp_highlighted");
return this},_highlightFirst:function(){this._addHighlight(this._firstSelectableItem());return this},_highlightPrev:function(){var a=this._highlighted().prevAll("li.mp_selectable:visible:first");a.length||(a=this._lastSelectableItem());this._addHighlight(a);return this},_highlightNext:function(){var a=this._highlighted().nextAll("li.mp_selectable:visible:first");a.length||(a=this._firstSelectableItem());this._addHighlight(a);return this},_showList:function(){var a=this.$list;a.children().length&&
a.show();return this},_hideList:function(){this.$list.hide();return this},_hideAndEmptyList:function(){this.$list.hide().empty();return this},_buildNoResultsList:function(a){var b=this.$input,c=this.$list,d=this.options,e=f('<li class="mp_no_results" />');(b=d.formatNoResults&&d.formatNoResults.call(b,a,e))&&e.html(b);this._trigger("noResults",[a,e]);b?(e.appendTo(c),this._showList()):this._hideList();return this},_buildResultsList:function(a,b){for(var c=this.$input,d=this.$list,e=this.options,h=
this.selected,g=e.compare&&h,i,k,n=!1,l=f(),j=0,m=b.length;j<m;j++)i=b[j],l=f('<li class="mp_item" />'),k=e.formatItem.call(c,i,l),l.data("marcoPolo",i),l.html(k).appendTo(d),g&&(!0===e.compare?k=h:(i=i[e.compare],k=h[e.compare]),i===k&&(this._addHighlight(l),g=!1,n=!0));d.children(e.selectable).addClass("mp_selectable");this._trigger("results",[b]);this._showList();n||this._highlightFirst();return this},_buildSuccessList:function(a,b){var c=this.$input,d=this.options;this.$list.empty();d.formatData&&
(b=d.formatData.call(c,b));f.isEmptyObject(b)?this._buildNoResultsList(a):this._buildResultsList(a,b);return this},_buildErrorList:function(a,b,c){var d=this.$input,e=this.$list,h=this.options,g=f('<li class="mp_error" />');e.empty();(d=h.formatError&&h.formatError.call(d,g,a,b,c))&&g.html(d);this._trigger("error",[g,a,b,c]);d?(g.appendTo(e),this._showList()):this._hideList();return this},_buildMinCharsList:function(a){var b=this.$input,c=this.$list,d=this.options,e=f('<li class="mp_min_chars" />');
if(!a.length)return this._hideAndEmptyList(),this;c.empty();(a=d.formatMinChars&&d.formatMinChars.call(b,d.minChars,e))&&e.html(a);this._trigger("minChars",[d.minChars,e]);a?(e.appendTo(c),this._showList()):this._hideList();return this},_cancelPendingRequest:function(){this.ajax?(this.ajaxAborted=!0,this.ajax.abort()):this.ajaxAborted=!1;clearTimeout(this.timer);return this},_change:function(a){this.selected=null;this.value=a;this._trigger("change",[a]);return this},_request:function(a){var b=this,
c=b.$input,d=b.options;b._cancelPendingRequest();a!==b.value&&b._change(a);b.timer=setTimeout(function(){var e={},h={},g,i=f();if(a.length<d.minChars)return b._buildMinCharsList(a),b;e[d.param]=a;h=f.extend({},d.data,e);g=d.url+(-1===d.url.indexOf("?")?"?":"&")+f.param(h);d.cache&&j[g]?b._buildSuccessList(a,j[g]):(b._trigger("requestBefore"),i=c.parent().addClass("mp_busy"),b.ajax=f.ajax({url:d.url,dataType:"json",data:h,success:function(c){b._buildSuccessList(a,c);d.cache&&(j[g]=c)},error:function(a,
c,d){b.ajaxAborted||b._buildErrorList(a,c,d)},complete:function(a,c){b.ajax=null;b.ajaxAborted=!1;i.removeClass("mp_busy");b._trigger("requestAfter",[a,c])}}))},d.delay);return b},_dismiss:function(){var a=this.$input,b=this.options;this._cancelPendingRequest()._hideAndEmptyList();b.required&&!this.selected&&(a.val(""),this._change(""));this._toggleLabel();return this},_trigger:function(a,b){var c="on"+a.charAt(0).toUpperCase()+a.slice(1),d=this.widgetEventPrefix.toLowerCase()+a.toLowerCase(),c=this.options[c];
this.element.trigger(d,b);return c&&c.apply(this.element,b)}})})(jQuery);
